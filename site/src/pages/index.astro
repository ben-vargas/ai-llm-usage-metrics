---
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import { readFileSync } from 'node:fs';
import { resolve } from 'node:path';

const rootPkg = JSON.parse(
  readFileSync(resolve(process.cwd(), '..', 'package.json'), 'utf-8'),
);
const pkgVersion = rootPkg.version ?? '0.0.0';

const basePath = import.meta.env.BASE_URL.endsWith('/')
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;
const docsPath = `${basePath}getting-started/`;
const efficiencyPath = `${basePath}efficiency/`;
const benchmarksPath = `${basePath}benchmarks/`;
---

<StarlightPage frontmatter={{ title: 'Overview', template: 'splash' }}>
  <div class="grid-bg" aria-hidden="true"></div>

  <!-- Version Pill (Floating Top Right) -->
  <a href="https://github.com/ayagmar/llm-usage-metrics/releases" class="version-pill-floating font-mono fade-in" target="_blank" rel="noopener noreferrer">
    <span class="pulse-dot"></span> v{pkgVersion}
  </a>

  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-inner">
      <div class="hero-content fade-in">
        <h1 class="title">
          Know exactly what your<br/> <span class="text-dim-accent">AI coding costs.</span>
        </h1>
        <p class="desc">
          High-performance local usage metrics for pi, Codex, Gemini CLI, and OpenCode. Parse tokens, apply real pricing, and correlate spend with Git outcomes. Sub-second reports. Zero telemetry.
        </p>

        <div class="actions">
          <div
            class="install-box"
            role="button"
            tabindex="0"
            aria-label="Copy install command: npm i -g llm-usage-metrics"
          >
            <span class="prompt text-dim">$</span>
            <span class="cmd font-mono">npm i -g llm-usage-metrics</span>
            <span class="copy-icon">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </span>
          </div>
          <div class="btn-group">
            <a href={docsPath} class="btn btn-primary">Documentation</a>
            <a href="https://github.com/ayagmar/llm-usage-metrics" class="btn btn-secondary" target="_blank" rel="noopener noreferrer">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
              GitHub
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Metrics Bar -->
  <section class="metrics-bar fade-in" style="animation-delay: 100ms">
    <div class="metrics-inner">
      <div class="metric">
        <div class="metric-val font-mono">4</div>
        <div class="metric-label">Supported Agents</div>
      </div>
      <div class="metric">
        <div class="metric-val font-mono">100<span class="text-dim">%</span></div>
        <div class="metric-label">Local-First</div>
      </div>
      <div class="metric">
        <div class="metric-val font-mono">0</div>
        <div class="metric-label">Telemetry</div>
      </div>
      <div class="metric">
        <div class="metric-val font-mono"><span class="text-dim">O(</span>1<span class="text-dim">)</span></div>
        <div class="metric-label">Parse Cache</div>
      </div>
    </div>
  </section>

  <!-- Bento Features -->
  <section class="features fade-in" style="animation-delay: 200ms">
    <div class="section-head">
      <h2 class="section-title">Built for engineers.</h2>
      <p class="section-desc">Signal over noise. Sub-second performance. CLI-first design.</p>
    </div>
    
    <div class="bento-grid">
      <!-- 1: Efficiency -->
      <div class="bento-cell span-2">
        <div class="cell-content">
          <div class="cell-header">
            <h3 class="cell-title">Efficiency ROI</h3>
            <p class="cell-desc">The first CLI to join your local Git outcomes with LLM costs. View your true $/commit and $/1k lines metrics directly in your terminal or export to JSON.</p>
          </div>
          <div class="cell-footer mt-auto">
            <pre class="code-block font-mono"><code>$ llm-usage efficiency monthly --repo-dir .</code></pre>
            <a href={efficiencyPath} class="cell-link">Read efficiency docs &rarr;</a>
          </div>
        </div>
      </div>

      <!-- 2: Parsers -->
      <div class="bento-cell">
        <div class="cell-content">
          <div class="cell-header">
            <h3 class="cell-title">Universal Parsers</h3>
            <p class="cell-desc">Zero-config discovery for <code>.pi</code>, <code>.codex</code>, <code>.gemini</code>, and OpenCode SQLite databases. Automatic adapter routing.</p>
          </div>
          <div class="cell-visual tags-visual mt-auto">
            <span class="agent-tag">.pi</span>
            <span class="agent-tag">.codex</span>
            <span class="agent-tag">.gemini</span>
            <span class="agent-tag">sqlite</span>
          </div>
        </div>
      </div>

      <!-- 3: Caching -->
      <div class="bento-cell">
        <div class="cell-content">
          <div class="cell-header">
            <h3 class="cell-title">Parse Cache</h3>
            <p class="cell-desc">Session files are parsed once and cached locally. Subsequent runs skip unchanged files for instant, deterministic reporting.</p>
          </div>
          <div class="cell-visual cache-visual mt-auto">
            <div class="cache-line"><span class="text-dim">✔ cache hit:</span> 0ms</div>
            <div class="cache-line"><span class="text-dim">✔ cache hit:</span> 0ms</div>
          </div>
        </div>
      </div>

      <!-- 4: Formats -->
      <div class="bento-cell span-2 split-cell">
        <div class="cell-content">
          <div class="cell-header">
            <h3 class="cell-title">JSON, Markdown & ANSI</h3>
            <p class="cell-desc">Pipe <code>--json</code> into jq. Paste <code>--markdown</code> into GitHub PRs. Or read perfectly aligned ANSI tables in your terminal.</p>
          </div>
        </div>
        <div class="cell-visual">
          <pre class="code-block font-mono" style="margin-bottom: 0; width: 100%;"><code>$ llm-usage daily --json | jq '.totals.cost'</code></pre>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-inner">
      <div class="brand">
        <svg width="16" height="16" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect width="32" height="32" rx="8" fill="currentColor"/>
          <path d="M8 12h16M8 16h12M8 20h8" stroke="var(--color-bg)" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span class="font-mono">llm-usage-metrics</span>
      </div>
      <div class="links">
        <a href={docsPath}>Docs</a>
        <a href={benchmarksPath}>Benchmarks</a>
        <a href="https://github.com/ayagmar/llm-usage-metrics" target="_blank" rel="noopener noreferrer">GitHub</a>
      </div>
    </div>
  </footer>

  <script is:inline>
    const box = document.querySelector('.install-box');
    box?.addEventListener('click', () => {
      if(!navigator.clipboard?.writeText) return;
      navigator.clipboard.writeText('npm install -g llm-usage-metrics').then(() => {
        const icon = box.querySelector('.copy-icon');
        if (!icon) return;

        icon.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
        setTimeout(() => {
          icon.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
        }, 2000);
      }).catch(() => {
        // no-op: clipboard may be unavailable due browser permissions/context.
      });
    });
    box?.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        box.click();
      }
    });
  </script>
</StarlightPage>

<style>
  /* Override Starlight Defaults for Splash Page */
  :global(main > .content-panel:has(h1#_top)) { display: none !important; }
  :global(main > .content-panel) { padding: 0 !important; max-width: 100% !important; border: none !important; }
  :global(.sl-container) { max-width: 100% !important; margin: 0 !important; }
  :global(starlight-menu-button) { display: none !important; }

  /* Animations */
  @keyframes fade-in-up {
    from {
      opacity: 0;
      transform: translateY(12px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .fade-in {
    animation: fade-in-up var(--transition-slow) forwards;
    opacity: 0;
  }

  /* Grid Background Overlay */
  .grid-bg {
    position: fixed;
    inset: 0;
    z-index: -1;
    pointer-events: none;
    background-image: 
      linear-gradient(to right, var(--border-default) 1px, transparent 1px),
      linear-gradient(to bottom, var(--border-default) 1px, transparent 1px);
    background-size: 4rem 4rem;
    mask-image: radial-gradient(circle at top, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 80%);
    -webkit-mask-image: radial-gradient(circle at top, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 80%);
  }
  :root[data-theme='light'] .grid-bg {
    opacity: 0.3;
  }

  /* Shared Container */
  .hero-inner, .features, .footer-inner {
    max-width: var(--max-w-container);
    margin: 0 auto;
    padding: 0 var(--space-6);
  }

  /* Hero Section */
  .hero {
    padding: var(--space-24) 0 var(--space-20);
  }
  .hero-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }
  .hero-content {
    max-width: 800px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .version-pill-floating {
    position: absolute;
    top: var(--space-6);
    right: var(--space-6);
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-1) var(--space-3);
    font-size: var(--text-xs);
    font-weight: 500;
    border: 1px solid var(--border-strong);
    border-radius: var(--radius-full);
    background: var(--color-bg-elevated);
    color: var(--color-text-muted);
    text-decoration: none;
    transition: all var(--transition-fast);
    z-index: var(--z-fixed);
  }
  .version-pill-floating:hover {
    border-color: var(--color-text-dim);
    color: var(--color-text-secondary);
    transform: translateY(-1px);
    background: var(--color-bg-code);
  }
  .pulse-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--color-text-dim);
    box-shadow: 0 0 0 rgba(255,255,255,0.4);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(113, 113, 122, 0.7); }
    70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(113, 113, 122, 0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(113, 113, 122, 0); }
  }

  .title {
    font-size: clamp(2.5rem, 6vw, 4.5rem);
    font-weight: 600;
    line-height: 1.05;
    letter-spacing: var(--tracking-tighter);
    margin-bottom: var(--space-6);
    text-wrap: balance;
    color: var(--color-text);
  }
  
  .text-dim-accent {
    color: var(--color-text-dim);
    font-weight: 500;
  }

  .desc {
    font-size: var(--text-lg);
    color: var(--color-text-secondary);
    line-height: var(--leading-relaxed);
    margin-bottom: var(--space-10);
    max-width: 65ch;
    text-wrap: balance;
  }

  .actions {
    --action-height: 2.75rem;
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    align-items: stretch;
    width: 100%;
    justify-content: center;
  }
  @media (min-width: 768px) {
    .actions {
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: var(--space-3);
    }
  }

  .install-box {
    display: inline-flex;
    align-items: center;
    gap: var(--space-3);
    padding: 0 var(--space-4);
    min-height: var(--action-height);
    height: var(--action-height);
    background: var(--color-bg-code);
    border: 1px solid var(--border-strong);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    box-sizing: border-box;
    margin: 0;
    white-space: nowrap;
    line-height: 1;
  }
  .install-box:hover {
    background: var(--color-bg-elevated);
    border-color: var(--color-text-muted);
    transform: translateY(-1px);
  }
  .install-box .cmd {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: 1;
    display: inline-flex;
    align-items: center;
    white-space: nowrap;
  }
  .prompt {
    line-height: 1;
    display: flex;
    align-items: center;
  }
  .copy-icon {
    color: var(--color-text-dim);
    display: flex;
    align-items: center;
    margin-left: var(--space-1);
  }
  .copy-icon svg {
    display: block;
  }

  .btn-group {
    display: flex;
    gap: var(--space-3);
    align-items: stretch;
    min-height: var(--action-height);
    height: var(--action-height);
    line-height: 1;
  }
  
  .btn {
    height: 100%;
    min-height: var(--action-height);
    border-radius: var(--radius-md);
    padding: 0 var(--space-5);
    font-weight: 500;
    flex: 1;
    box-sizing: border-box;
    margin: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    white-space: nowrap;
  }
  .btn svg {
    display: block;
  }
  @media (min-width: 768px) {
    .btn {
      flex: none;
    }
  }

  /* Metrics Bar */
  .metrics-bar {
    border-top: 1px solid var(--border-subtle);
    border-bottom: 1px solid var(--border-subtle);
    background: linear-gradient(to right, transparent, var(--color-bg-elevated), transparent);
    margin-bottom: var(--space-16);
  }
  .metrics-inner {
    max-width: var(--max-w-container);
    margin: 0 auto;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
    padding: 0 var(--space-6);
    align-items: stretch;
  }
  @media (min-width: 768px) {
    .metrics-inner {
      grid-template-columns: repeat(4, 1fr);
    }
  }
  .metric {
    padding: var(--space-10) 0;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 9rem;
  }
  .metric-val {
    font-size: var(--text-3xl);
    font-weight: 500;
    color: var(--color-text);
    margin-bottom: var(--space-2);
    letter-spacing: var(--tracking-tighter);
    line-height: 1;
    display: flex;
    align-items: baseline;
    justify-content: center;
    height: 40px;
  }
  .metric-val .text-dim {
    font-size: 0.85em;
  }
  .metric-label {
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-dim);
    line-height: 1;
  }

  /* Features Bento */
  .features {
    padding: var(--space-16) var(--space-6);
  }
  .section-head {
    margin-bottom: var(--space-12);
    text-align: center;
  }
  .section-title {
    font-size: var(--text-3xl);
    font-weight: 600;
    letter-spacing: var(--tracking-tighter);
    margin-bottom: var(--space-3);
  }
  .section-desc {
    color: var(--color-text-muted);
    font-size: var(--text-lg);
  }

  .bento-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-6);
    align-items: stretch;
  }
  @media (min-width: 768px) {
    .bento-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  .bento-cell {
    background: var(--color-bg-card);
    border: 1px solid var(--border-strong);
    border-radius: var(--radius-lg);
    padding: var(--space-8);
    display: flex;
    flex-direction: column;
    transition: all var(--transition-base);
    position: relative;
    overflow: hidden;
  }
  .bento-cell:hover {
    border-color: var(--color-text-muted);
    background: var(--color-bg-elevated);
    box-shadow: var(--shadow-elevated), var(--glow-accent);
    transform: translateY(-2px);
  }
  .cell-content {
    display: flex;
    flex-direction: column;
    height: 100%;
    z-index: 1;
  }
  .cell-header {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }
  .span-2 {
    grid-column: span 1;
  }
  @media (min-width: 768px) {
    .span-2 {
      grid-column: span 2;
    }
  }

  .split-cell {
    flex-direction: column;
  }
  @media (min-width: 768px) {
    .split-cell {
      flex-direction: row;
      align-items: stretch;
      gap: var(--space-8);
    }
    .split-cell .cell-content {
      flex: 1;
      justify-content: center;
    }
    .split-cell .cell-visual {
      flex: 1.2;
      width: 100%;
      display: flex;
      align-items: center;
    }
  }

  .cell-title {
    font-size: var(--text-xl);
    font-weight: 600;
    margin: 0 0 var(--space-2);
    letter-spacing: var(--tracking-tight);
  }
  .cell-desc {
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
    line-height: 1.6;
    margin: 0 0 var(--space-6);
  }
  .cell-footer.mt-auto {
    margin-top: auto;
    padding-top: var(--space-4);
  }
  .tags-visual {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }
  .agent-tag {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    padding: var(--space-1) var(--space-3);
    background: var(--color-bg-elevated);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-sm);
    color: var(--color-text-secondary);
  }
  .cache-visual {
    background: var(--color-bg-code);
    border: 1px solid var(--border-subtle);
    padding: var(--space-4);
    border-radius: var(--radius-md);
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }
  .cache-line {
    color: var(--color-text-secondary);
  }
  .code-block {
    background: var(--color-bg-code);
    border: 1px solid var(--border-default);
    padding: var(--space-4);
    border-radius: var(--radius-md);
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    overflow-x: auto;
    margin-bottom: var(--space-4);
    white-space: pre-wrap;
    word-break: break-all;
  }
  .cell-link {
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    transition: all var(--transition-fast);
  }
  .cell-link:hover {
    gap: var(--space-3);
    text-decoration: none;
    color: var(--color-cyan);
  }


  /* Footer */
  .footer {
    border-top: 1px solid var(--border-subtle);
    padding: var(--space-12) 0;
    margin-top: var(--space-16);
  }
  .footer-inner {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
    align-items: center;
    justify-content: space-between;
  }
  @media (min-width: 600px) {
    .footer-inner {
      flex-direction: row;
    }
  }
  .brand {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text);
  }
  .links {
    display: flex;
    gap: var(--space-8);
  }
  .links a {
    color: var(--color-text-dim);
    font-size: var(--text-sm);
    text-decoration: none;
    transition: color var(--transition-fast);
  }
  .links a:hover {
    color: var(--color-text);
  }
</style>
