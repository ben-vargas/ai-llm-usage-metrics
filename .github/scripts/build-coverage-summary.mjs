import { readFileSync, writeFileSync } from 'node:fs';

const inputPath = 'coverage/coverage-summary.json';
const outputPath = 'coverage/summary.md';

const coverageSummary = JSON.parse(readFileSync(inputPath, 'utf8'));
const totals = coverageSummary.total;

if (!totals) {
  throw new Error(`Could not find total coverage metrics in ${inputPath}`);
}

const percentage = (value) => `${value.toFixed(2)}%`;

const markdown = [
  '## Test Coverage',
  '',
  '| Metric | Percent | Covered / Total |',
  '|---|---:|---:|',
  `| Lines | ${percentage(totals.lines.pct)} | ${totals.lines.covered} / ${totals.lines.total} |`,
  `| Statements | ${percentage(totals.statements.pct)} | ${totals.statements.covered} / ${totals.statements.total} |`,
  `| Functions | ${percentage(totals.functions.pct)} | ${totals.functions.covered} / ${totals.functions.total} |`,
  `| Branches | ${percentage(totals.branches.pct)} | ${totals.branches.covered} / ${totals.branches.total} |`,
  '',
  '_Generated by Vitest coverage report._',
].join('\n');

writeFileSync(outputPath, markdown, 'utf8');
